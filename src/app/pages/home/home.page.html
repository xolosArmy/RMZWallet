<ion-header>
  <ion-toolbar>
    <ion-title>Home</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card color="warning" *ngIf="!isOnline">
    <ion-card-content>
      Estás sin conexión. Se muestra la información disponible en caché.
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Gestión de Cartera</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>Genera una nueva cartera para comenzar a recibir eCash.</p>
      <ion-button
        expand="block"
        color="primary"
        (click)="onCreateWallet()"
        [disabled]="isCreatingWallet"
      >
        {{ isCreatingWallet ? 'Creando…' : 'Crear Cartera' }}
      </ion-button>
      <ion-text color="danger" *ngIf="errorMessage && !hasWallet">
        <p class="error-text">{{ errorMessage }}</p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="hasWallet">
    <ion-card-header>
      <ion-card-title>Información de la Cartera</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none">
        <ion-label class="label-title">Dirección</ion-label>
      </ion-item>
      <ion-item lines="none">
        <ion-label class="address-label">{{ wallet?.address }}</ion-label>
      </ion-item>

      <ion-item lines="none" class="balance-row">
        <ion-label class="label-title">Saldo</ion-label>
        <ion-button
          slot="end"
          size="small"
          fill="outline"
          (click)="refreshBalance()"
          [disabled]="isRefreshingBalance"
        >
          {{ isRefreshingBalance ? 'Actualizando…' : 'Actualizar Saldo' }}
        </ion-button>
      </ion-item>
      <ion-item lines="none">
        <ion-label>{{ formattedBalance }}</ion-label>
      </ion-item>

      <ion-item lines="none">
        <ion-label>
          <h3>Xolos RMZ (RMZ)</h3>
          <p class="token-balance">{{ formattedRmzBalance }}</p>
          <p class="token-id">ID: {{ rmzTokenId }}</p>
        </ion-label>
      </ion-item>

      <ion-button expand="block" color="secondary" (click)="openSendModal()">
        Enviar
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-text color="danger" *ngIf="errorMessage && hasWallet">
    <p class="error-text">{{ errorMessage }}</p>
  </ion-text>

  <ion-modal [isOpen]="isSendModalOpen" (didDismiss)="closeSendModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Enviar XEC</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeSendModal()" [disabled]="isSending">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form [formGroup]="sendForm" (ngSubmit)="onSubmitSend()">
          <ion-item>
            <ion-label position="stacked">Dirección destino</ion-label>
            <ion-input formControlName="destination" required></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Monto (XEC)</ion-label>
            <ion-input
              type="number"
              min="0.000001"
              step="0.000001"
              formControlName="amount"
              required
            ></ion-input>
          </ion-item>

          <ion-text color="danger" *ngIf="sendErrorMessage">
            <p class="error-text">{{ sendErrorMessage }}</p>
          </ion-text>

          <ion-text color="medium" *ngIf="ble.connectedDevice">
            <ion-icon name="bluetooth-outline"></ion-icon> Envío por BLE activo
          </ion-text>
          <ion-text color="warning" *ngIf="!ble.connectedDevice">
            <ion-icon name="cloud-outline"></ion-icon> Envío por Internet (fallback)
          </ion-text>

        <ion-button
          expand="block"
          type="submit"
          [disabled]="sendForm.invalid || isSending"
        >
          {{ isSending ? 'Enviando…' : 'Enviar' }}
        </ion-button>
      </form>

      <ion-text class="ion-margin-top token-section-title">
        <h2>Enviar Xolos RMZ</h2>
      </ion-text>
      <ion-item lines="none">
        <ion-note>Token ID: {{ rmzTokenId }}</ion-note>
      </ion-item>

      <form [formGroup]="rmzSendForm" (ngSubmit)="onSubmitSendToken()">
        <ion-item>
          <ion-label position="stacked">Dirección destino</ion-label>
          <ion-input formControlName="tokenDestination" required></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Cantidad (RMZ)</ion-label>
          <ion-input
            type="number"
            min="1"
            step="1"
            formControlName="tokenAmount"
            required
          ></ion-input>
        </ion-item>

        <ion-text color="danger" *ngIf="rmzSendErrorMessage">
          <p class="error-text">{{ rmzSendErrorMessage }}</p>
        </ion-text>

        <ion-button
          expand="block"
          type="submit"
          [disabled]="rmzSendForm.invalid || isSendingToken"
        >
          {{ isSendingToken ? 'Enviando…' : 'Enviar eToken' }}
        </ion-button>
      </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
